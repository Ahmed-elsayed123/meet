<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dashboard - Meeting App</title>
    <link
      rel="icon"
      href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ðŸ“…</text></svg>"
    />
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome for Icons -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"
    />
    <style>
      /* Custom styles for the Inter font */
      @import url("https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap");
      body {
        font-family: "Inter", sans-serif;
        background-color: #f5f7fa;
        min-height: 100vh;
      }
      .card {
        background-color: #ffffff;
        border-radius: 1rem;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.06);
        padding: 1.5rem;
        transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        border: 1px solid #e2e8f0;
      }
      .card:hover {
        transform: translateY(-4px);
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
      }
      .btn-primary {
        background-image: linear-gradient(to right, #2563eb, #3b82f6);
        color: white;
        padding: 0.8rem 1.8rem;
        border-radius: 0.75rem;
        font-weight: 600;
        transition: all 0.2s ease-in-out;
        box-shadow: 0 4px 10px rgba(59, 130, 246, 0.3);
        display: inline-flex;
        align-items: center;
        justify-content: center;
      }
      .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 15px rgba(59, 130, 246, 0.4);
      }
      .btn-danger {
        background-image: linear-gradient(to right, #dc2626, #ef4444);
        color: white;
        padding: 0.8rem 1.8rem;
        border-radius: 0.75rem;
        font-weight: 600;
        transition: all 0.2s ease-in-out;
        box-shadow: 0 4px 10px rgba(239, 68, 68, 0.3);
        display: inline-flex;
        align-items: center;
        justify-content: center;
      }
      .btn-danger:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 15px rgba(239, 68, 68, 0.4);
      }
      .btn-secondary {
        background-color: #f0f2f5;
        color: #4a5568;
        padding: 0.8rem 1.8rem;
        border-radius: 0.75rem;
        font-weight: 600;
        transition: all 0.2s ease-in-out;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        display: inline-flex;
        align-items: center;
        justify-content: center;
        border: 1px solid #cbd5e0;
      }
      .btn-secondary:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 15px rgba(0, 0, 0, 0.15);
        background-color: #e2e8f0;
      }
      .avatar {
        width: 80px;
        height: 80px;
        border-radius: 50%;
        object-fit: cover;
        border: 3px solid #ffffff;
        box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2);
      }
      .loading {
        display: inline-block;
        width: 20px;
        height: 20px;
        border: 3px solid rgba(255, 255, 255, 0.3);
        border-radius: 50%;
        border-top-color: #fff;
        animation: spin 1s ease-in-out infinite;
      }
      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }
      .modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.6);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 2000;
        opacity: 0;
        visibility: hidden;
        transition: opacity 0.3s ease-in-out, visibility 0.3s ease-in-out;
      }
      .modal.open {
        opacity: 1;
        visibility: visible;
      }
      .modal-content {
        background-color: #ffffff;
        padding: 2.5rem;
        border-radius: 1rem;
        box-shadow: 0 20px 30px -5px rgba(0, 0, 0, 0.15),
          0 10px 15px -5px rgba(0, 0, 0, 0.08);
        width: 90%;
        max-width: 550px;
        position: relative;
      }
      .modal-close-btn {
        position: absolute;
        top: 1.2rem;
        right: 1.2rem;
        background: none;
        border: none;
        font-size: 1.8rem;
        cursor: pointer;
        color: #718096;
        transition: color 0.2s ease-in-out;
      }
      .modal-close-btn:hover {
        color: #4a5568;
      }
      .form-input {
        width: 100%;
        padding: 0.85rem 1rem;
        margin-bottom: 1.25rem;
        border: 1px solid #cbd5e0;
        border-radius: 0.75rem;
        font-size: 1rem;
        transition: border-color 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        outline: none;
      }
      .form-input:focus {
        border-color: #3b82f6;
        box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.2);
      }
      .message-box {
        background-color: #fef2f2;
        color: #ef4444;
        border: 1px solid #ef4444;
        border-radius: 0.5rem;
        padding: 0.75rem 1rem;
        margin-top: 1rem;
        font-size: 0.9rem;
        text-align: center;
        display: none;
      }
      .message-box.success {
        background-color: #ecfdf5;
        color: #10b981;
        border-color: #10b981;
      }
    </style>
  </head>
  <body>
    <div class="min-h-screen bg-gray-50">
      <!-- Header -->
      <header class="bg-white shadow-sm border-b border-gray-200">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
          <div class="flex justify-between items-center py-6">
            <div class="flex items-center">
              <h1 class="text-2xl font-bold text-gray-900">
                Meeting App Dashboard
              </h1>
            </div>
            <button id="logoutBtn" class="btn-danger">
              <i class="fas fa-sign-out-alt mr-2"></i>
              <span id="logoutBtnText">Logout</span>
              <span
                id="logoutBtnSpinner"
                class="loading"
                style="display: none"
              ></span>
            </button>
          </div>
        </div>
      </header>

      <!-- Main Content -->
      <main class="max-w-7xl mx-auto py-6 sm:px-6 lg:px-8">
        <!-- Welcome Section -->
        <div class="px-4 py-6 sm:px-0">
          <div class="card">
            <div class="flex items-center space-x-6">
              <img
                id="userAvatar"
                src="https://placehold.co/80x80/3B82F6/FFFFFF?text=U"
                alt="User Avatar"
                class="avatar"
              />
              <div class="flex-1">
                <h2
                  class="text-3xl font-bold text-gray-900 mb-2"
                  id="welcomeMessage"
                >
                  Welcome!
                </h2>
                <p class="text-gray-600 text-lg" id="userEmail">
                  Loading user information...
                </p>
                <p class="text-gray-500" id="userName">Loading...</p>
              </div>
            </div>
          </div>
        </div>

        <!-- Stats Section -->
        <div class="px-4 py-6 sm:px-0">
          <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <div class="card text-center">
              <div
                class="text-4xl font-bold text-blue-600 mb-2"
                id="totalMeetingsCount"
              >
                0
              </div>
              <div class="text-gray-600">Total Meetings</div>
            </div>
            <div class="card text-center">
              <div
                class="text-4xl font-bold text-green-600 mb-2"
                id="upcomingMeetingsCount"
              >
                0
              </div>
              <div class="text-gray-600">Upcoming Meetings</div>
            </div>
            <div class="card text-center">
              <div
                class="text-4xl font-bold text-purple-600 mb-2"
                id="totalParticipantsCount"
              >
                0
              </div>
              <div class="text-gray-600">Participants</div>
            </div>
          </div>
        </div>

        <!-- Quick Actions -->
        <div class="px-4 py-6 sm:px-0">
          <div class="card">
            <h3 class="text-xl font-semibold text-gray-900 mb-4">
              Quick Actions
            </h3>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
              <button class="btn-primary" id="scheduleMeetingBtn">
                <i class="fas fa-plus-circle mr-2"></i>
                Schedule Meeting
              </button>
              <button class="btn-primary" id="joinMeetingBtn">
                <i class="fas fa-video mr-2"></i>
                Join Meeting
              </button>
              <button class="btn-primary">
                <i class="fas fa-users mr-2"></i>
                Manage Team
              </button>
              <button class="btn-primary">
                <i class="fas fa-cog mr-2"></i>
                Settings
              </button>
            </div>
          </div>
        </div>

        <!-- Upcoming Meetings -->
        <div class="px-4 py-6 sm:px-0">
          <div class="card">
            <h3 class="text-xl font-semibold text-gray-900 mb-4">
              Upcoming Meetings
            </h3>
            <div id="upcomingMeetingsList" class="space-y-4">
              <div class="text-center text-gray-500 py-8">
                <i class="fas fa-calendar-plus text-4xl mb-4"></i>
                <p>No upcoming meetings</p>
                <p class="text-sm">Schedule a meeting to get started</p>
              </div>
            </div>
          </div>
        </div>

        <!-- Past Meetings -->
        <div class="px-4 py-6 sm:px-0">
          <div class="card">
            <h3 class="text-xl font-semibold text-gray-900 mb-4">
              Past Meetings
            </h3>
            <div id="pastMeetingsList" class="space-y-4">
              <div class="text-center text-gray-500 py-8">
                <i class="fas fa-history text-4xl mb-4"></i>
                <p>No past meetings</p>
                <p class="text-sm">Your completed meetings will appear here</p>
              </div>
            </div>
          </div>
        </div>
      </main>
    </div>

    <!-- Schedule Meeting Modal -->
    <div id="scheduleMeetingModal" class="modal">
      <div class="modal-content">
        <button class="modal-close-btn" id="closeModalBtn">
          <i class="fas fa-times"></i>
        </button>
        <h2 class="text-2xl font-bold text-gray-800 mb-6 text-center">
          Schedule New Meeting
        </h2>
        <form id="meetingForm">
          <label
            for="meetingTitle"
            class="block text-gray-700 text-sm font-bold mb-2"
            >Meeting Title</label
          >
          <input
            type="text"
            id="meetingTitle"
            class="form-input"
            placeholder="Enter meeting title"
            required
          />

          <div class="grid grid-cols-2 gap-4">
            <div>
              <label
                for="meetingDate"
                class="block text-gray-700 text-sm font-bold mb-2"
                >Date</label
              >
              <input type="date" id="meetingDate" class="form-input" required />
            </div>
            <div>
              <label
                for="meetingTime"
                class="block text-gray-700 text-sm font-bold mb-2"
                >Time</label
              >
              <input type="time" id="meetingTime" class="form-input" required />
            </div>
          </div>

          <div>
            <label
              for="meetingDuration"
              class="block text-gray-700 text-sm font-bold mb-2"
              >Duration</label
            >
            <select id="meetingDuration" class="form-input" required>
              <option value="">Select duration</option>
              <option value="15">15 minutes</option>
              <option value="30">30 minutes</option>
              <option value="45">45 minutes</option>
              <option value="60">1 hour</option>
              <option value="90">1.5 hours</option>
              <option value="120">2 hours</option>
            </select>
          </div>

          <div>
            <label
              for="meetingDescription"
              class="block text-gray-700 text-sm font-bold mb-2"
              >Description</label
            >
            <textarea
              id="meetingDescription"
              class="form-input"
              rows="3"
              placeholder="Enter meeting description"
            ></textarea>
          </div>

          <div>
            <label
              for="meetingParticipants"
              class="block text-gray-700 text-sm font-bold mb-2"
              >Participants</label
            >
            <textarea
              id="meetingParticipants"
              class="form-input"
              rows="2"
              placeholder="Enter participant emails (one per line)"
            ></textarea>
          </div>

          <div class="flex gap-4 mt-6">
            <button type="submit" class="btn-primary flex-1">
              <span id="submitBtnText">Schedule Meeting</span>
              <div id="submitBtnSpinner" class="spinner hidden"></div>
            </button>
            <button
              type="button"
              class="btn-secondary flex-1"
              id="cancelScheduleBtn"
            >
              Cancel
            </button>
          </div>
        </form>
        <div id="meetingMessage" class="message-box"></div>
      </div>
    </div>

    <!-- Join Meeting Modal -->
    <div id="joinMeetingModal" class="modal">
      <div class="modal-content">
        <button class="modal-close-btn" id="closeJoinModalBtn">
          <i class="fas fa-times"></i>
        </button>
        <h2 class="text-2xl font-bold text-gray-800 mb-6 text-center">
          Join Meeting
        </h2>
        <form id="joinMeetingForm">
          <div class="mb-6">
            <label
              for="meetingIdInput"
              class="block text-gray-700 text-sm font-bold mb-2"
              >Meeting ID</label
            >
            <input
              type="text"
              id="meetingIdInput"
              class="form-input"
              placeholder="Enter meeting ID"
              required
            />
            <p class="text-sm text-gray-600 mt-2">
              Enter the meeting ID provided by the meeting organizer
            </p>
          </div>

          <div class="mb-6">
            <label
              for="userNameInput"
              class="block text-gray-700 text-sm font-bold mb-2"
              >Your Name</label
            >
            <input
              type="text"
              id="userNameInput"
              class="form-input"
              placeholder="Enter your name"
              required
            />
          </div>

          <div class="mb-6">
            <div
              class="flex items-center justify-between p-4 bg-gray-50 rounded-lg"
            >
              <div class="flex items-center">
                <i class="fas fa-microphone text-gray-600 mr-3"></i>
                <span class="text-gray-700">Audio Test</span>
              </div>
              <button
                type="button"
                id="testAudioBtn"
                class="btn-secondary text-sm"
              >
                <i class="fas fa-play mr-1"></i> Test
              </button>
            </div>
            <p class="text-sm text-gray-600 mt-2">
              Test your microphone before joining
            </p>
          </div>

          <div class="flex gap-4">
            <button type="submit" class="btn-primary flex-1">
              <span id="joinBtnText">Join Meeting</span>
              <div id="joinBtnSpinner" class="spinner hidden"></div>
            </button>
            <button
              type="button"
              class="btn-secondary flex-1"
              id="cancelJoinBtn"
            >
              Cancel
            </button>
          </div>
        </form>
        <div id="joinMessage" class="message-box"></div>
      </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
      // Import the functions you need from the SDKs you need
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
      import {
        getAuth,
        onAuthStateChanged,
        signOut,
      } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
      import {
        getFirestore,
        doc,
        getDoc,
        setDoc,
        collection,
        addDoc,
        serverTimestamp,
      } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

      // Your web app's Firebase configuration
      const firebaseConfig = {
        apiKey: "AIzaSyDRZbmJ1Xz9T-wtNouK202LElIgY3Ub_VY",
        authDomain: "proapp-ae75d.firebaseapp.com",
        projectId: "proapp-ae75d",
        storageBucket: "proapp-ae75d.firebasestorage.app",
        messagingSenderId: "1051955180155",
        appId: "1:1051955180155:web:7200f3db3023cf94f8e8de",
        measurementId: "G-QF88WEY2SK",
      };

      // Initialize Firebase
      let app, auth, db;
      try {
        app = initializeApp(firebaseConfig);
        auth = getAuth(app);
        db = getFirestore(app);
        console.log("Firebase initialized successfully");
      } catch (error) {
        console.error("Firebase initialization error:", error);
      }

      // Make Firebase auth available globally
      window.auth = auth;
      window.db = db;
      window.signOut = signOut;
      window.getDoc = getDoc;
      window.doc = doc;
      window.setDoc = setDoc;
      window.collection = collection;
      window.addDoc = addDoc;
      window.serverTimestamp = serverTimestamp;

      // Check authentication state
      onAuthStateChanged(auth, async (user) => {
        if (user) {
          console.log("User is signed in:", user.email);
          await loadUserProfile(user);
        } else {
          console.log("No user is signed in, redirecting to login");
          window.location.href = "/";
        }
      });

      // Function to load user profile from Firestore
      async function loadUserProfile(user) {
        try {
          const userDoc = await getDoc(doc(db, "users", user.uid));
          if (userDoc.exists()) {
            const userData = userDoc.data();
            displayUserInfo(user, userData);
          } else {
            displayUserInfo(user, null);
          }
        } catch (error) {
          console.warn("Failed to load user profile:", error);
          displayUserInfo(user, null);
        }
      }

      // Function to display user information
      function displayUserInfo(user, userData) {
        const welcomeMessage = document.getElementById("welcomeMessage");
        const userEmail = document.getElementById("userEmail");
        const userName = document.getElementById("userName");
        const userAvatar = document.getElementById("userAvatar");

        // Set user email
        userEmail.textContent = user.email;

        // Set user name
        if (userData && userData.name) {
          userName.textContent = userData.name;
          welcomeMessage.textContent = `Welcome, ${userData.name}!`;
        } else if (user.displayName) {
          userName.textContent = user.displayName;
          welcomeMessage.textContent = `Welcome, ${user.displayName}!`;
        } else {
          userName.textContent = "User";
          welcomeMessage.textContent = "Welcome!";
        }

        // Set user avatar
        if (user.photoURL) {
          userAvatar.src = user.photoURL;
        } else if (userData && userData.name) {
          userAvatar.src = `https://placehold.co/80x80/3B82F6/FFFFFF?text=${userData.name
            .charAt(0)
            .toUpperCase()}`;
        } else {
          userAvatar.src = `https://placehold.co/80x80/3B82F6/FFFFFF?text=${user.email
            .charAt(0)
            .toUpperCase()}`;
        }

        // Load and display meetings after user info is loaded
        loadAndDisplayMeetings();
      }

      // Local Storage Functions
      function getMeetingsFromStorage() {
        const meetings = localStorage.getItem("meetings");
        return meetings ? JSON.parse(meetings) : [];
      }

      function saveMeetingsToStorage(meetings) {
        localStorage.setItem("meetings", JSON.stringify(meetings));
      }

      function addMeetingToStorage(meeting) {
        const meetings = getMeetingsFromStorage();
        meetings.push(meeting);
        saveMeetingsToStorage(meetings);
      }

      function updateMeetingInStorage(meetingId, updatedMeeting) {
        const meetings = getMeetingsFromStorage();
        const index = meetings.findIndex((m) => m.id === meetingId);
        if (index !== -1) {
          meetings[index] = updatedMeeting;
          saveMeetingsToStorage(meetings);
        }
      }

      function deleteMeetingFromStorage(meetingId) {
        const meetings = getMeetingsFromStorage();
        const filteredMeetings = meetings.filter((m) => m.id !== meetingId);
        saveMeetingsToStorage(filteredMeetings);
      }

      // Make localStorage functions available globally
      window.getMeetingsFromStorage = getMeetingsFromStorage;
      window.saveMeetingsToStorage = saveMeetingsToStorage;
      window.addMeetingToStorage = addMeetingToStorage;
      window.updateMeetingInStorage = updateMeetingInStorage;
      window.deleteMeetingFromStorage = deleteMeetingFromStorage;
      window.loadAndDisplayMeetings = loadAndDisplayMeetings;

      // Meeting Display Functions
      function loadAndDisplayMeetings() {
        const meetings = getMeetingsFromStorage();
        const now = new Date();

        const upcomingMeetings = [];
        const pastMeetings = [];
        let totalParticipants = new Set();

        meetings.forEach((meeting) => {
          const meetingDateTime = new Date(`${meeting.date}T${meeting.time}`);

          // Add participants to total count
          meeting.participants.forEach((p) => totalParticipants.add(p));

          if (meetingDateTime > now) {
            upcomingMeetings.push(meeting);
          } else {
            pastMeetings.push(meeting);
          }
        });

        // Update stats
        document.getElementById("totalMeetingsCount").textContent =
          meetings.length;
        document.getElementById("upcomingMeetingsCount").textContent =
          upcomingMeetings.length;
        document.getElementById("totalParticipantsCount").textContent =
          totalParticipants.size;

        // Display meetings
        displayMeetings("upcomingMeetingsList", upcomingMeetings, "upcoming");
        displayMeetings("pastMeetingsList", pastMeetings, "past");
      }

      function displayMeetings(containerId, meetings, type) {
        const container = document.getElementById(containerId);

        if (meetings.length === 0) {
          container.innerHTML = `
             <div class="text-center text-gray-500 py-8">
               <i class="fas fa-${
                 type === "upcoming" ? "calendar-plus" : "history"
               } text-4xl mb-4"></i>
               <p>No ${type} meetings</p>
               <p class="text-sm">${
                 type === "upcoming"
                   ? "Schedule a meeting to get started"
                   : "Your completed meetings will appear here"
               }</p>
             </div>
           `;
          return;
        }

        // Sort meetings by date and time
        meetings.sort((a, b) => {
          const dateA = new Date(`${a.date}T${a.time}`);
          const dateB = new Date(`${b.date}T${b.time}`);
          return type === "upcoming" ? dateA - dateB : dateB - dateA;
        });

        container.innerHTML = meetings
          .map((meeting) => createMeetingCard(meeting, type))
          .join("");
      }

      function createMeetingCard(meeting, type) {
        const meetingDateTime = new Date(`${meeting.date}T${meeting.time}`);
        const formattedDate = meetingDateTime.toLocaleDateString("en-US", {
          weekday: "short",
          month: "short",
          day: "numeric",
          year: "numeric",
        });
        const formattedTime = meetingDateTime.toLocaleTimeString("en-US", {
          hour: "2-digit",
          minute: "2-digit",
          hour12: true,
        });

        return `
           <div class="border border-gray-200 rounded-lg p-4 hover:shadow-md transition-shadow">
             <div class="flex justify-between items-start mb-3">
               <div class="flex-1">
                 <h4 class="text-lg font-semibold text-gray-900 mb-1">${
                   meeting.title
                 }</h4>
                 <p class="text-sm text-gray-600 mb-2">
                   <i class="fas fa-calendar-alt mr-1"></i>
                   ${formattedDate} at ${formattedTime}
                 </p>
                 <p class="text-sm text-gray-600 mb-2">
                   <i class="fas fa-clock mr-1"></i>
                   ${meeting.duration} minutes
                 </p>
                 ${
                   meeting.description
                     ? `<p class="text-sm text-gray-600 mb-2">${meeting.description}</p>`
                     : ""
                 }
                 <div class="flex flex-wrap gap-1 mb-3">
                   ${meeting.participants
                     .map(
                       (email) => `
                     <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                       <i class="fas fa-user mr-1"></i>
                       ${email}
                     </span>
                   `
                     )
                     .join("")}
                 </div>
               </div>
               <div class="flex flex-col gap-2">
                 ${
                   type === "upcoming"
                     ? `
                   <button onclick="joinMeeting('${meeting.id}')" class="btn-primary text-sm px-3 py-1">
                     <i class="fas fa-video mr-1"></i>
                     Join
                   </button>
                   <button onclick="editMeeting('${meeting.id}')" class="btn-secondary text-sm px-3 py-1">
                     <i class="fas fa-edit mr-1"></i>
                     Edit
                   </button>
                   <button onclick="deleteMeeting('${meeting.id}')" class="btn-danger text-sm px-3 py-1">
                     <i class="fas fa-trash mr-1"></i>
                     Delete
                   </button>
                 `
                     : `
                   <span class="text-sm text-gray-500">
                     <i class="fas fa-check-circle mr-1"></i>
                     Completed
                   </span>
                 `
                 }
               </div>
             </div>
           </div>
         `;
      }

      // Meeting Action Functions
      function joinMeeting(meetingId) {
        // Redirect to meeting room with meeting ID
        window.location.href = `/meeting-room?id=${meetingId}`;
      }

      function editMeeting(meetingId) {
        alert("Edit meeting functionality will be implemented here");
      }

      function deleteMeeting(meetingId) {
        if (confirm("Are you sure you want to delete this meeting?")) {
          deleteMeetingFromStorage(meetingId);
          loadAndDisplayMeetings();
        }
      }

      // Make meeting action functions available globally
      window.joinMeeting = joinMeeting;
      window.editMeeting = editMeeting;
      window.deleteMeeting = deleteMeeting;
    </script>

    <script>
      // Function to set loading state
      function setLoading(buttonId, textId, spinnerId, isLoading) {
        const button = document.getElementById(buttonId);
        const text = document.getElementById(textId);
        const spinner = document.getElementById(spinnerId);

        if (!button || !text || !spinner) {
          console.warn("One or more elements not found for loading state:", {
            buttonId,
            textId,
            spinnerId,
          });
          return;
        }

        if (isLoading) {
          button.disabled = true;
          text.style.display = "none";
          spinner.style.display = "inline-block";
        } else {
          button.disabled = false;
          text.style.display = "inline";
          spinner.style.display = "none";
        }
      }

      // Function to handle logout
      async function handleLogout() {
        setLoading("logoutBtn", "logoutBtnText", "logoutBtnSpinner", true);

        try {
          await window.signOut(window.auth);
          console.log("User signed out successfully");
          window.location.href = "/";
        } catch (error) {
          console.error("Logout error:", error);
          alert("Logout failed. Please try again.");
        } finally {
          setLoading("logoutBtn", "logoutBtnText", "logoutBtnSpinner", false);
        }
      }

      // Add event listener to logout button
      document
        .getElementById("logoutBtn")
        .addEventListener("click", handleLogout);

      // Modal functionality
      const scheduleMeetingBtn = document.getElementById("scheduleMeetingBtn");
      const joinMeetingBtn = document.getElementById("joinMeetingBtn");
      const scheduleMeetingModal = document.getElementById(
        "scheduleMeetingModal"
      );
      const joinMeetingModal = document.getElementById("joinMeetingModal");
      const closeModalBtn = document.getElementById("closeModalBtn");
      const closeJoinModalBtn = document.getElementById("closeJoinModalBtn");
      const meetingForm = document.getElementById("meetingForm");
      const joinMeetingForm = document.getElementById("joinMeetingForm");
      const meetingMessageDiv = document.getElementById("meetingMessage");
      const joinMessageDiv = document.getElementById("joinMessage");
      const testAudioBtn = document.getElementById("testAudioBtn");
      const cancelScheduleBtn = document.getElementById("cancelScheduleBtn");
      const cancelJoinBtn = document.getElementById("cancelJoinBtn");

      // Function to display messages
      function showMessage(element, message, isSuccess = false) {
        element.textContent = message;
        element.classList.remove("hidden", "success");
        element.classList.add("block");
        if (isSuccess) {
          element.classList.add("success");
        } else {
          element.classList.remove("success");
        }
      }

      // Function to hide messages
      function hideMessage(element) {
        element.textContent = "";
        element.classList.remove("block", "success");
        element.classList.add("hidden");
      }

      // Open modal
      scheduleMeetingBtn.addEventListener("click", () => {
        scheduleMeetingModal.classList.add("open");
        hideMessage(meetingMessageDiv);
        meetingForm.reset();

        // Set minimum date to today
        const today = new Date().toISOString().split("T")[0];
        document.getElementById("meetingDate").min = today;
      });

      // Close modal
      closeModalBtn.addEventListener("click", () => {
        scheduleMeetingModal.classList.remove("open");
      });

      // Close modal if clicked outside content
      scheduleMeetingModal.addEventListener("click", (e) => {
        if (e.target === scheduleMeetingModal) {
          scheduleMeetingModal.classList.remove("open");
        }
      });

      // Join meeting modal functionality
      joinMeetingBtn.addEventListener("click", () => {
        joinMeetingModal.classList.add("open");
        hideMessage(joinMessageDiv);
        // Pre-fill user name if available
        const userNameInput = document.getElementById("userNameInput");
        if (window.auth && window.auth.currentUser) {
          const user = window.auth.currentUser;
          userNameInput.value = user.displayName || user.email.split("@")[0];
        }
      });

      // Close join meeting modal
      closeJoinModalBtn.addEventListener("click", () => {
        joinMeetingModal.classList.remove("open");
      });

      cancelJoinBtn.addEventListener("click", () => {
        joinMeetingModal.classList.remove("open");
      });

      // Close join meeting modal if clicked outside content
      joinMeetingModal.addEventListener("click", (e) => {
        if (e.target === joinMeetingModal) {
          joinMeetingModal.classList.remove("open");
        }
      });

      // Audio test functionality
      let testStream = null;
      testAudioBtn.addEventListener("click", async () => {
        try {
          if (testStream) {
            // Stop current test
            testStream.getTracks().forEach((track) => track.stop());
            testStream = null;
            testAudioBtn.innerHTML = '<i class="fas fa-play mr-1"></i> Test';
            testAudioBtn.classList.remove("btn-danger");
            testAudioBtn.classList.add("btn-secondary");
            showMessage(joinMessageDiv, "Audio test stopped", true);
          } else {
            // Start audio test
            testStream = await navigator.mediaDevices.getUserMedia({
              audio: true,
            });
            testAudioBtn.innerHTML = '<i class="fas fa-stop mr-1"></i> Stop';
            testAudioBtn.classList.remove("btn-secondary");
            testAudioBtn.classList.add("btn-danger");
            showMessage(
              joinMessageDiv,
              "Audio test started - speak to test your microphone",
              true
            );
          }
        } catch (error) {
          console.error("Audio test error:", error);
          showMessage(
            joinMessageDiv,
            "Unable to access microphone. Please check permissions."
          );
        }
      });

      // Handle join meeting form submission
      joinMeetingForm.addEventListener("submit", async (event) => {
        event.preventDefault();

        const meetingId = document
          .getElementById("meetingIdInput")
          .value.trim();
        const userName = document.getElementById("userNameInput").value.trim();

        if (!meetingId || !userName) {
          showMessage(joinMessageDiv, "Please fill in all fields.");
          return;
        }

        // Set loading state
        setLoading("joinBtn", "joinBtnText", "joinBtnSpinner", true);

        try {
          // Check if meeting exists in localStorage
          const meetings = JSON.parse(localStorage.getItem("meetings") || "[]");
          const meeting = meetings.find((m) => m.id === meetingId);

          // If meeting not found in localStorage, it might be a shared room ID
          // We'll allow joining anyway and let the meeting room handle it
          if (!meeting) {
            console.log(
              "Meeting not found in localStorage, but allowing join for shared room ID:",
              meetingId
            );
            // Create a temporary meeting entry for shared rooms
            const tempMeeting = {
              id: meetingId,
              title: `Shared Meeting (${meetingId})`,
              date: new Date().toLocaleDateString(),
              time: new Date().toLocaleTimeString(),
              createdBy: "Shared Room",
              participants: [],
            };

            // Add to localStorage so the meeting room can find it
            meetings.push(tempMeeting);
            localStorage.setItem("meetings", JSON.stringify(meetings));
          }

          // Stop audio test if running
          if (testStream) {
            testStream.getTracks().forEach((track) => track.stop());
            testStream = null;
          }

          // Redirect to meeting room
          window.location.href = `/meeting-room?id=${meetingId}`;
        } catch (error) {
          console.error("Join meeting error:", error);
          showMessage(
            joinMessageDiv,
            "Failed to join meeting. Please try again."
          );
        } finally {
          setLoading("joinBtn", "joinBtnText", "joinBtnSpinner", false);
        }
      });

      // Handle form submission
      meetingForm.addEventListener("submit", async (event) => {
        event.preventDefault();

        const title = document.getElementById("meetingTitle").value;
        const date = document.getElementById("meetingDate").value;
        const time = document.getElementById("meetingTime").value;
        const duration = document.getElementById("meetingDuration").value;
        const description = document.getElementById("meetingDescription").value;
        const participantsInput = document.getElementById(
          "meetingParticipants"
        ).value;

        // Basic validation
        if (!title || !date || !time || !duration) {
          showMessage(meetingMessageDiv, "Please fill in all required fields.");
          return;
        }

        // Validate date and time
        const meetingDateTime = new Date(`${date}T${time}`);
        const now = new Date();
        if (meetingDateTime <= now) {
          showMessage(
            meetingMessageDiv,
            "Meeting date and time must be in the future."
          );
          return;
        }

        // Process participants
        const participants = participantsInput
          .split(",")
          .map((p) => p.trim())
          .filter((p) => p !== "");

        // Basic email validation for participants
        const emailRegex = /\S+@\S+\.\S+/;
        const invalidParticipants = participants.filter(
          (p) => !emailRegex.test(p)
        );
        if (invalidParticipants.length > 0) {
          showMessage(
            meetingMessageDiv,
            `Invalid email format for: ${invalidParticipants.join(", ")}`
          );
          return;
        }

        // Set loading state
        setLoading("submitBtn", "submitBtnText", "submitBtnSpinner", true);

        try {
          // Get current user
          const user = window.auth.currentUser;
          if (!user) {
            throw new Error("User not authenticated");
          }

          // Create meeting data with unique ID
          const meetingData = {
            id: Date.now().toString() + Math.random().toString(36).substr(2, 9),
            title: title,
            date: date,
            time: time,
            duration: parseInt(duration),
            description: description || "",
            participants: participants,
            createdBy: user.uid,
            createdByEmail: user.email,
            createdAt: new Date().toISOString(),
            status: "scheduled",
          };

          // Save to localStorage
          window.addMeetingToStorage(meetingData);

          console.log("Meeting created successfully:", meetingData.id);
          showMessage(
            meetingMessageDiv,
            "Meeting scheduled successfully!",
            true
          );

          // Refresh meetings display
          window.loadAndDisplayMeetings();

          // Reset form and close modal after delay
          setTimeout(() => {
            meetingForm.reset();
            scheduleMeetingModal.classList.remove("open");
            hideMessage(meetingMessageDiv);
          }, 2000);
        } catch (error) {
          console.error("Error creating meeting:", error);
          showMessage(
            meetingMessageDiv,
            "Failed to create meeting. Please try again."
          );
        } finally {
          setLoading("submitBtn", "submitBtnText", "submitBtnSpinner", false);
        }
      });

      // Check if user is trying to join via shared link
      const urlParams = new URLSearchParams(window.location.search);
      const sharedMeetingId = urlParams.get("join");
      if (sharedMeetingId) {
        // Auto-open join meeting modal with pre-filled meeting ID
        setTimeout(() => {
          joinMeetingModal.classList.add("open");
          document.getElementById("meetingIdInput").value = sharedMeetingId;
          // Pre-fill user name if available
          const userNameInput = document.getElementById("userNameInput");
          if (window.auth && window.auth.currentUser) {
            const user = window.auth.currentUser;
            userNameInput.value = user.displayName || user.email.split("@")[0];
          }
        }, 1000); // Small delay to ensure page is loaded
      }
    </script>
  </body>
</html>
